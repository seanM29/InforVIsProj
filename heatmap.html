<!DOCTYPE html>
<html lang="en">

<head>
    <!DOCTYPE html>
    <html>

    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=gs00r5tgNZG32bkjCnE5BWdyaSxeI18V"></script>
        <script type="text/javascript" src="http://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js">
        </script>
        <title>热力图功能示例</title>
        <style type="text/css">
        ul,
        li {
            list-style: none;
            margin: 0;
            padding: 0;
            float: left;
        }

        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0px;
            padding: 0px;
            font-family: "微软雅黑";
        }

        #container {
            height: 650px;
            width: 100%;
            margin-top: 5px;
        }

        #r-result {
            width: 100%;
        }
        </style>
        <script src="/socket.io/socket.io.js"></script>
        <script>
        var socket = io();
        </script>
    </head>

    <body  bgcolor="#DFE2DB">
        <select onchange="Timer(this.value)">
            <option value="Stop">Stop</option>
            <option value="Start">Start</option>
        </select>
        <select onchange="Change(this.value)">
            <option value="Heatmap">Heatmap</option>
            <option value="DataChart">DataChart</option>
            <option value="DataType">DataType</option>
            <option value="PipCharts">PipCharts</option>

        </select>
        <div class="Begin">
            
            <div class="left-element" id="CurTime" , style="text-align:center">
                Current Time:00:00-00:59
            </div>
        </div>
        <div id="container"></div>
        <div id="r-result">
        </div>
        ChooseDayTime:
        <input type="text" id="ChooseDayTime" style="margin-right: 10px" value="">
        <input type="button" onclick="ChooseDayTime()" value="Submit">
        <input type="button" onclick="Change()" value="Change">
    </body>

    </html>
    <script type="text/javascript">
    var map = new BMap.Map("container"); // 创建地图实例  

    var point = new BMap.Point(116.418261, 39.921984);
    map.centerAndZoom(point, 15); // 初始化地图，设置中心点坐标和地图级别  
    map.enableScrollWheelZoom(); // 允许滚轮缩放  

    var points = [

        //        { "lng": "116.43410492", "lat": "39.96931839", "count": "100" },
        //       { "lng": "116.43395233", "lat": "39.97468948", "count": "100" },

    ];


    if (!isSupportCanvas()) {
        alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~')
    }
    //详细的参数,可以查看heatmap.js的文档 https://github.com/pa7/heatmap.js/blob/master/README.md  
    //参数说明如下:  
    /* visible 热力图是否显示,默认为true  
     * opacity 热力的透明度,1-100  
     * radius 势力图的每个点的半径大小  
     * gradient  {JSON} 热力图的渐变区间 . gradient如下所示  
     *  {  
            .2:'rgb(0, 255, 255)',  
            .5:'rgb(0, 110, 255)',  
            .8:'rgb(100, 0, 255)'  
        }  
        其中 key 表示插值的位置, 0~1.  
            value 为颜色值.  
     */
    heatmapOverlay = new BMapLib.HeatmapOverlay({ "radius": 20 });
    map.addOverlay(heatmapOverlay);
    heatmapOverlay.setDataSet({ data: points, max: 100 });

    closeHeatmap();

    //判断浏览区是否支持canvas  
    function isSupportCanvas() {
        var elem = document.createElement('canvas');
        return !!(elem.getContext && elem.getContext('2d'));
    }

    function setGradient() {
        /*格式如下所示:  
        {  
            0:'rgb(102, 255, 0)',  
            .5:'rgb(255, 170, 0)',  
            1:'rgb(255, 0, 0)'  
        }*/
        var gradient = {};
        var colors = document.querySelectorAll("input[type='color']");
        colors = [].slice.call(colors, 0);
        colors.forEach(function(ele) {
            gradient[ele.getAttribute("data-key")] = ele.value;
        });
        heatmapOverlay.setOptions({ "gradient": gradient });
    }

    function openHeatmap() {
        heatmapOverlay.show();
        console.log("show heat map");
    }

    function closeHeatmap() {
        heatmapOverlay.hide();
    }

    function ChooseDayTime() {
        socket.emit('DayTime', $('#ChooseDayTime').val());
        $('#ChooseDayTime').val('');

    }
    window.onload = function() {
        openHeatmap()
    }
    var filename_index = 0;
    var t;
    var WhetherStart = 0;

    //循环控制
    function Start() {

        var filename = "./Data/20170226/" + filename_index + ".json"
        console.log(filename_index);
        var timedisplay;
        if(filename_index<10){
            timedisplay="Current Time:0"+filename_index.toString() +":00-0"+filename_index.toString()+":59"
        }
        else{
           timedisplay="Current Time:"+filename_index.toString()+":00-"+filename_index.toString()+":59" 
        }
       
        document.getElementById('CurTime').innerHTML=timedisplay
        filename_index++;

        if (filename_index == 24) {
            filename_index = 0;
        }
        socket.emit('StartChange', filename);
        t = setTimeout("Start()", 2000);

    }

    function Stop() {
        clearTimeout(t)
    }

    function Timer(selectedValue) {
        console.log(selectedValue)
        if (selectedValue == "Start") {
            Start();
        } else {
            Stop()
        }
    }

    function Change(selectedValue) {
         if (selectedValue == "Heatmap") {
            window.location.href = "/demo.html"
        }else if(selectedValue == "DataChart"){
            window.location.href = "/DataChart.html"
        }else if(selectedValue == "DataType"){
            window.location.href = "/DataType.html"
        }else {
            window.location.href = "/PipCharts.html"
        }
        
        // socket.emit('Display', 1); //display chart table
    }
    socket.on('SendData', function(msg) {
        //console.log(11)
        points = []
        for (var index in msg) {
            //console.log(msg[index].lat)
            //console.log(msg[index].lng)
            var p = {};
            p.lng = msg[index].lng
            p.lat = msg[index].lat
            p.count = 100
            points.push(p)
        }

        heatmapOverlay.setDataSet({ data: points, max: 100 });
        //console.log(leng(points))

    });
    </script>
    </body>

</html>